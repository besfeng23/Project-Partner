rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
  
    // Helper function to get user's role in an organization
    function getUserRole(orgId) {
      return get(/databases/$(database)/documents/orgs/$(orgId)/users/$(request.auth.uid)).data.role;
    }

    // Path for project-specific uploads
    // orgs/{orgId}/projects/{projectId}/uploads/{filename}
    match /orgs/{orgId}/projects/{projectId}/uploads/{allPaths=**} {
      // Allow read access to members of the organization
      allow read: if request.auth != null && getUserRole(orgId) in ['admin', 'member', 'viewer'];
      
      // Allow write access (create, update, delete) to members and admins
      allow write: if request.auth != null && getUserRole(orgId) in ['admin', 'member'];
    }
  }
}
