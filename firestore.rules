rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    // --- Helper Functions ---
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOrgMember(orgId) {
      return exists(/databases/$(database)/documents/orgs/$(orgId)/memberships/$(request.auth.uid));
    }

    function getRole(orgId) {
      return get(/databases/$(database)/documents/orgs/$(orgId)/memberships/$(request.auth.uid)).data.role;
    }

    function isRole(orgId, role) {
      return isOrgMember(orgId) && getRole(orgId) == role;
    }
    
    function isRoleIn(orgId, roles) {
      return isOrgMember(orgId) && getRole(orgId) in roles;
    }

    // --- Rules ---
    
    // Orgs collection
    match /orgs/{orgId} {
      // Anyone authenticated can create an org, they become admin
      allow create: if isAuthenticated();
      // Only members can read org details
      allow read: if isOrgMember(orgId);
      // Only admins can update org details
      allow update: if isRole(orgId, 'admin');

      // Memberships subcollection
      match /memberships/{uid} {
        // Members can see who else is in the org
        allow read: if isOrgMember(orgId);
        // Admins can add/remove/change roles of members.
        // Users can add themselves as members (e.g. on invite accept), but cannot set their own role to admin.
        allow write: if isRole(orgId, 'admin') || 
                      (request.auth.uid == uid && request.resource.data.role != 'admin');
      }

      // Projects subcollection
      match /projects/{projectId} {
        // Members can read project details
        allow read: if isOrgMember(orgId);
        // Only admins and members can create/update projects
        allow write: if isRoleIn(orgId, ['admin', 'member']);
        
        // --- Project Subcollections ---

        // Tasks
        match /tasks/{taskId} {
          allow read: if isOrgMember(orgId);
          allow write: if isRoleIn(orgId, ['admin', 'member']);
        }

        // Decisions (Append-only)
        match /decisions/{decisionId} {
          allow read: if isOrgMember(orgId);
          allow create: if isRoleIn(orgId, ['admin', 'member']);
          allow update, delete: if false; // NEVER allow updates or deletes
        }
        
        // Constraints
        match /constraints/{constraintId} {
          allow read: if isOrgMember(orgId);
          allow write: if isRoleIn(orgId, ['admin', 'member']);
        }
        
        // Artifacts
        match /artifacts/{artifactId} {
           allow read: if isOrgMember(orgId);
           allow write: if isRoleIn(orgId, ['admin', 'member']);
        }
        
        // Vercel Connector
        match /connectors/vercel {
           allow read: if isOrgMember(orgId);
           allow write: if isRoleIn(orgId, ['admin', 'member']); // Client can connect
        }

        // Chat Threads & Messages
        match /chatThreads/{threadId} {
          allow read, write: if isRoleIn(orgId, ['admin', 'member']);
          match /messages/{messageId} {
            allow read, create: if isRoleIn(orgId, ['admin', 'member']);
            // Only admin can edit/delete history for moderation
            allow update, delete: if isRole(orgId, 'admin'); 
          }
        }
        
        // Memory Summaries (AI generated)
        match /memorySummaries/{summaryId} {
          allow read: if isOrgMember(orgId);
          // Only backend process should create/write summaries
          allow write: if false; 
        }
        
        // Audit (Append-only, Server-only)
        match /audit/{eventId} {
          // Only admins can review audit logs
          allow read: if isRole(orgId, 'admin');
          // Only backend process can create audit logs
          allow write: if false;
        }
      }
    }
  }
}
